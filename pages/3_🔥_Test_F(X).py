import streamlit as st
import json
import yfinance as yf
import re
import math

# ==============================================================================
# 1. CORE ENGINE: Dynamic Calculation Logic (Refactored Goal)
# ==============================================================================
class SmartCFEngine:
    def __init__(self, ticker, data):
        self.ticker = ticker
        self.events = data.get("events", [])
        self.beta_memory = data.get("beta_memory", 0.0)
        self.extra_iv_str = data.get("extra_iv_str", "")  # For manual IV text appending
        
        # State variables
        self.b = 0.0  # Accumulated Realized P&L
        self.history_logs = []
        self.final_str = ""
        self.original_str = ""
        
        self._process_events()

    def _safe_ln(self, val):
        """Logarithm wrapper to prevent math errors on <= 0"""
        try:
            return math.log(val) if val > 0 else 0.0
        except ValueError:
            return 0.0

    def _process_events(self):
        if not self.events:
            return

        # --- 1. Setup Initial State from First Event ---
        first = self.events[0]
        curr_c = float(first.get("capital", 0))
        # Ref defaults to price if not set
        curr_t = float(first.get("ref", first.get("price"))) 
        # Start Price
        curr_p = float(first.get("price"))
        
        self.original_str = f"‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: {curr_t:.2f}, ‡∏ó‡∏∏‡∏ô‡∏Ñ‡∏á‡∏ó‡∏µ‡πà: {curr_c:.0f}"
        
        # --- 2. Iterate through subsequent events ---
        for i, event in enumerate(self.events[1:], start=1):
            next_p = float(event.get("price"))
            next_c = float(event.get("capital", curr_c))
            next_t = float(event.get("ref", curr_t)) 
            
            # THE EQUATION: b += c * ln(P/t) - c' * ln(P/t')
            # term_old: profit generated by old capital moving from old ref to new price
            term_old = curr_c * self._safe_ln(next_p / curr_t)
            # term_new: cost basis adjustment for new capital/ref at new price
            term_new = next_c * self._safe_ln(next_p / next_t)
            
            delta_b = term_old - term_new
            self.b += delta_b
            
            # Generate History Strings (Maintaining exact legacy format)
            # History X: Summary
            hist_str = (
                f"‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: {curr_t} ‚Üí {next_t}, "
                f"‡∏ó‡∏∏‡∏ô‡∏Ñ‡∏á‡∏ó‡∏µ‡πà: {curr_c} ‚Üí {next_c} , "
                f"‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô : {next_p}"
            )
            
            # History X.1: Equation Debug
            # Display logic: 2 decimal places for legibility
            eq_debug = (
                f"{self.b - delta_b:.2f} += "
                f"({curr_c} * ln({next_p}/{curr_t})) - "
                f"({next_c} * ln({next_p}/{next_t})) | "
                f"c = {next_c} , t = {next_t} , b = {self.b:.2f}"
            )
            
            self.history_logs.append({
                "summary": hist_str,
                "equation": eq_debug,
                "note": event.get("note", "")
            })
            
            # Update State for next iteration
            curr_c = next_c
            curr_t = next_t
            curr_p = next_p

        # --- 3. Final State Summary ---
        # Format: "Ref, Capital, P&L"
        self.final_str = f"{curr_t}, {curr_c}, {self.b:.2f}"

    def to_legacy_dict(self):
        """Converts internal state to the exact dictionary structure required by existing UI"""
        
        # Calculate EV part for beta_Equation
        # Logic: EV = Net_Memory - Realized_PnL
        # Because Net = Realized + EV  => EV = Net - Realized
        ev_val = self.beta_memory - self.b
        
        # Construct beta_equation string
        # Default format: " Ev: {ev} + Lock_P&L: {b} {extra}"
        beta_eq_str = f" Ev: {ev_val:+.2f} + Lock_P&L: {self.b:+.2f}"
        if self.extra_iv_str:
             beta_eq_str += f" {self.extra_iv_str}"

        res = {
            "ticker": self.ticker,
            "Final": self.final_str,
            "Original": self.original_str,
            "Equation": "b += c ¬∑ ln(P / t) - c' ¬∑ ln(P / t'); ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡πâ‡∏á P = P', t = t', c = c'",
            "comment": " ‚Üí ".join([e["note"] for e in self.history_logs if e["note"]]),
            "beta_Equation": beta_eq_str,
            "beta_momory": f"Net: {self.beta_memory:+.2f}"
        }
        
        # Inject numbered histories (history_1, history_1.1, etc.)
        for i, log in enumerate(self.history_logs, 1):
            res[f"history_{i}"] = log["summary"]
            res[f"history_{i}.1"] = log["equation"]
            
        return res

# ==============================================================================
# 2. DATA CONFIGURATION (Dynamic Source)
# ==============================================================================
# ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Demo ‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤ (‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Event Format) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
DEMO_SMART_DATA = {
    "FFWM": {
        "events": [
            { "price": 6.88, "capital": 1500, "ref": 6.88, "note": "Start" }
        ],
        "beta_memory": -204.00
    },
    "NEGG": {
        "events": [
            { "price": 1.26, "capital": 1500, "ref": 1.26, "note": "T" },
            { "price": 25.2, "capital": 1500, "ref": 25.2, "note": "C" },
            { "price": 25.2, "capital": 1000, "ref": 25.2, "note": "C" },
            { "price": 79.79,"capital": 800,  "ref": 25.2, "note": "C" },
            { "price": 128.09,"capital": 500, "ref": 25.2, "note": "C" },
            { "price": 46.8, "capital": 0.01, "ref": 25.2, "note": "End" }
        ],
        "beta_memory": 1027.28
    },
    "RIVN": {
        "events": [
            { "price": 10.07, "capital": 1500, "ref": 10.07, "note": "Start" },
            { "price": 14.20, "capital": 1500, "ref": 14.20, "note": "T" },
            { "price": 12.00, "capital": 1500, "ref": 12.00, "note": "T" },
            { "price": 16.41, "capital": 4000, "ref": 12.00, "note": "C" }
        ],
        "extra_iv_str": "-438+599+485", # Custom append from your example
        "beta_memory": -686.97
    },
     "APLS": {
        "events": [
            { "price": 39.61, "capital": 1500, "ref": 39.61, "note": "Start" },
            { "price": 24.00, "capital": 2500, "ref": 30.20, "note": "T & C" },
            { "price": 28.50, "capital": 2700, "ref": 28.50, "note": "T" }
        ],
        "beta_memory": -1351.91
    },
    "NVTS": {
        "events": [
            { "price": 3.05, "capital": 1500, "ref": 3.05, "note": "Start" },
            { "price": 8.25, "capital": 1500, "ref": 8.25, "note": "T" },
            { "price": 12.00, "capital": 1500, "ref": 12.00, "note": "T" },
            { "price": 15.76, "capital": 2000, "ref": 12.00, "note": "C" },
            { "price": 10.80, "capital": 2200, "ref": 12.00, "note": "C" }
        ],
        "extra_iv_str": "|+134",
        "beta_memory": 380.83
    },
    # ... ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÑ‡∏î‡πâ‡πÉ‡∏ô pattern ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ...
}

def load_and_transform_config():
    """Attempts to load smart_cf_config.json, falls back to DEMO_DATA, then transforms to legacy format."""
    raw_data = {}
    
    # 1. Try loading external file
    try:
        with open("smart_cf_config.json", "r", encoding="utf-8") as f:
            raw_data = json.load(f)
    except FileNotFoundError:
        # 2. Fallback to Demo Data (so the code works immediately for you)
        # st.warning("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå 'smart_cf_config.json' - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Demo ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÇ‡∏Ñ‡πâ‡∏î")
        raw_data = DEMO_SMART_DATA

    # 3. Transform using Engine
    legacy_style_config = []
    for ticker, data in raw_data.items():
        engine = SmartCFEngine(ticker, data)
        legacy_style_config.append(engine.to_legacy_dict())
        
    return legacy_style_config

# ==============================================================================
# 3. STREAMLIT APP (UI Preservation Goal)
# ==============================================================================
st.set_page_config(page_title="CF_Graph", page_icon="üî•", layout="wide")

# Load Config via Engine
assets_config = load_and_transform_config()

# --- Everything below this line preserves your EXACT UI Logic ---

tab_names = ["DATA", "Roll_Over" , "All_Ticker" , "Historical_Backtest_CF" , "Call_ratio_spread" , "Extrinsic_Value_(EV)"]  
tabs = st.tabs(tab_names)

current_prices = {}
asset_params = {}

with tabs[1]:
    with st.expander("‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£ Rollover"):
        st.components.v1.iframe("https://monica.im/share/artifact?id=E9Mg5JX9RaAcfssZsU7K3E", width=1500, height=1000, scrolling=0)

with tabs[2]:
    with st.expander("All_Ticker", expanded=True):
        st.markdown(
        """ 
        ‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏¢‡∏∂‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: T_0 , ‡∏ó‡∏∏‡∏ô: C_0 )  ‡∏Ç‡∏≠‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏™‡∏°‡∏≠
        ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞ Rollover: T_Reference  , C_Capital  , P_Action ‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πá‡∏ï‡∏≤‡∏°
        
        EV (Extrinsic Value) = Premium - (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏∏‡πâ‡∏ô - Strike)
        P&L ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ = ‡∏Å‡∏≥‡πÑ‡∏£‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏∏‡πâ‡∏ô (b) ‡∏õ‡∏Å‡∏ï‡∏¥ -  net_EV  ( EV ‡πÉ‡∏´‡∏°‡πà - EV ‡πÄ‡∏Å‡πà‡∏≤)
        """ )        
        st.components.v1.iframe("https://monica.im/share/artifact?id=z6iWHpc2rQjTTMriGBbthi", width=1500, height=1000, scrolling=0)

with tabs[3]:
    with st.expander("Historical_Backtest_CF", expanded=True):
        st.components.v1.iframe("https://monica.im/share/artifact?id=DioBCRhLKWgMw2ey5YMRKJ", width=1500, height=1000, scrolling=0)
        with st.expander("Monthly", expanded=False):        
            st.components.v1.iframe("https://monica.im/share/artifact?id=cgYnircvQqM9YUf58VHd8a", width=1500, height=1000, scrolling=0)
        
with tabs[4]:
    with st.expander("3_piecewise_line", expanded=True):
        st.components.v1.iframe("https://monica.im/share/artifact?id=Z3pbuoEskKzxgxAEWqBYwJ", width=1500, height=1000, scrolling=0)
    with st.expander("3_piecewise_line_v1", expanded=False):
        st.components.v1.iframe("https://monica.im/share/artifact?id=t8qKXjs8Aywi3PcTf4pDZM", width=1500, height=1000, scrolling=0)

with tabs[5]:
    with st.expander("Stock_Replacement_P&L_Calculator", expanded=True):
        st.write("https://stockprice-firstnattapon.streamlit.app")
        st.components.v1.iframe("https://monica.im/share/artifact?id=o4ummrnvDbMBYtEZzU5o6Z", width=1500, height=1000, scrolling=0)
        st.components.v1.iframe("https://monica.im/share/artifact/preview?id=bUZu6BZhKCeDGSG7DQ5pWV", width=1500, height=1000, scrolling=0)
    with st.expander("Stock_Replacement_P&L_Calculator_v1", expanded=False):
        st.components.v1.iframe("https://monica.im/share/artifact?id=d8nc2e3fk3a6SAWxL7e6u3", width=1500, height=1000, scrolling=0)

def parse_final_two_numbers(s):
    nums = re.findall(r"[-+]?\d*\.?\d+", str(s))
    a = float(nums[0]) if len(nums) > 0 else 0.0
    b = float(nums[1]) if len(nums) > 1 else 0.0
    return a, b

with tabs[0]:
    st.write("‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Asset (Dynamic Engine Active üöÄ)")
    with st.expander(f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å beta_memory_EV"):
        st.components.v1.iframe("https://monica.im/share/artifact?id=atEAAsV4afxJTBq4jTM3YR", width=1500, height=1000, scrolling=0)

    with st.expander(f"pnl_tracking_strategy"):
        st.components.v1.iframe("https://monica.im/share/artifact?id=SAjLJA9EjhwvRPQySBW4A8", width=1500, height=1000, scrolling=0)

        st.markdown(
        """ 
        ‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏¢‡∏∂‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: T_0 , ‡∏ó‡∏∏‡∏ô: C_0 )  ‡∏Ç‡∏≠‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏™‡∏°‡∏≠
        ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞ Rollover: T_Reference  , C_Capital  , P_Action ‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πá‡∏ï‡∏≤‡∏°    
        """ )                
        
        st.json({
        "pnl_tracking_strategy": {
        "description": "‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡πÑ‡∏£‡πÅ‡∏•‡∏∞‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô (P&L) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≠‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥",
        "components": [
          {
            "variable_name": "accumulated_realized_pnl",
            "description": "‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏™‡∏∞‡∏™‡∏°‡∏à‡∏≤‡∏Å‡∏≠‡∏î‡∏µ‡∏ï",
            "purpose": "‡πÄ‡∏Å‡πá‡∏ö‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°‡∏à‡∏≤‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ô‡∏≥‡∏°‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô",
            "initial_value": -313.79
          },
          {
            "variable_name": "current_unrealized_pnl",
            "description": "‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô",
            "purpose": "‡πÉ‡∏ä‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÇ‡∏î‡∏¢‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å 0",
            "formula": "5000 * ln(P / 20.0)",
            "note": "‡∏Ñ‡πà‡∏≤ P ‡∏Ñ‡∏∑‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Price) ‡πÅ‡∏•‡∏∞ P&L ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÄ‡∏°‡∏∑‡πà‡∏≠ P = 20.0"
          },
          {
            "variable_name": "total_lifetime_pnl",
            "description": "‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô",
            "purpose": "‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
            "formula": "accumulated_realized_pnl + current_unrealized_pnl"
          }
        ],
        "summary": "‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö P&L ‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÄ‡∏™‡∏°‡∏≠ ‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏£‡∏±‡∏ö"
        }
        })
    
    st.write("---")
    # Loop ‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πä‡∏∞ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ assets_config ‡∏ñ‡∏π‡∏Å‡πÅ‡∏õ‡∏•‡∏á structure ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß
    for asset in assets_config:
        ticker = asset.get("ticker", "N/A")
        final_str = asset.get("Final", "N/A")
        
        # ‡πÄ‡∏û‡∏¥‡πà‡∏° Emoji ‡∏ö‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡πà‡∏≤‡∏ô Engine
        engine_indicator = "" # "‚ö°" if asset.get("beta_momory") else ""

        with st.expander(f"‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥: {ticker} {engine_indicator} | \"{final_str}\""):
            try:
                final_price, final_fav = parse_final_two_numbers(final_str)
                asset_params[ticker] = {"entry": final_price, "fav": final_fav}
                try:
                    last_price = yf.Ticker(ticker).fast_info.get("lastPrice", final_price)
                except Exception:
                    st.warning(f"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á {ticker} ‡πÑ‡∏î‡πâ, ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤ Final ‡πÅ‡∏ó‡∏ô")
                    last_price = final_price
                current_prices[ticker] = st.number_input("‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì)", step=0.01, value=float(last_price), key=f"price_{ticker}")
                st.write("---")
                
                # ‡πÅ‡∏™‡∏î‡∏á JSON ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£
                st.write("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏à‡∏≤‡∏Å Config (Calculated):")
                st.json(asset)
            except Exception as e:
                st.error(f"‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô config ‡∏Ç‡∏≠‡∏á {ticker} ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")
                asset_params[ticker] = {"entry": 0.0, "fav": 0.0}
                current_prices[ticker] = 0.0
